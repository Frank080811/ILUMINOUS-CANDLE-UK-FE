<!-- success.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment Success</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .success-message { text-align: center; margin: 40px 0; }
    .success-message h1 { color: var(--brand); font-size: 2rem; margin-bottom: 10px; }
    .success-message p { color: var(--muted); }
    .summary { margin-top: 30px; background: var(--card); padding: 24px; border-radius: 18px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    table th, table td { text-align: left; padding: 10px; }
    table th { background: #1a1a1a; color: var(--brand); font-weight: 600; text-transform: uppercase; font-size: 0.9rem; }
    table tr:nth-child(even) { background: #181818; }
    .totals td { font-weight: bold; }
    .btn-back { display: inline-block; margin-top: 20px; padding: 12px 20px; background: var(--brand); color: #111; font-weight: bold; border-radius: 12px; text-align: center; transition: background 0.3s ease, transform 0.3s ease; }
    .btn-back:hover { background: #9c6535; transform: translateY(-2px); }
    .error { color: var(--brand-2); font-weight: bold; text-align: center; margin-top: 20px; }
  </style>
</head>
<body>
<header class="header">
  <div class="container nav-container">
    <div class="logo">
      <a href="index.html"><img src="images/logo.png" alt="Company Logo"></a>
    </div>
    <nav class="navbar">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/shop">Shop</a></li>
        <li><a href="/contact">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>

<div class="container">
  <div class="success-message">
    <h1>üéâ Thank You for Your Purchase!</h1>
    <p>Your order has been received and is being processed.</p>
  </div>

  <div id="orderDetails" class="error">‚ö†Ô∏è Loading order details...</div>
</div>

<footer>
  <div class="footer-container">
    <div class="footer-col">
      <h4>About</h4>
      <ul>
        <li><a href="/about">Our Story</a></li>
        <li><a href="/contact">Contact</a></li>
      </ul>
    </div>
    <div class="footer-col">
      <h4>Follow Us</h4>
      <div class="footer-social">
        <a href="#"><i class="fab fa-facebook-f"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
      </div>
    </div>
  </div>
  <div class="sub-footer">¬© 2025 Candle Co. All rights reserved.</div>
</footer>

<script>
(async function() {
  const orderDetailsDiv = document.getElementById("orderDetails");
  const urlParams = new URLSearchParams(window.location.search);
  const checkoutId = urlParams.get("checkoutId");

  if (!checkoutId) {
    orderDetailsDiv.innerHTML = "‚ö†Ô∏è Missing checkout ID.";
    return;
  }

  console.log("‚úÖ Checkout ID found:", checkoutId);

  try {
    // 1Ô∏è‚É£ Load order details
    const response = await fetch(`https://iluminous-candle-uk-be.onrender.com/order/${checkoutId}`);
    console.log("‚û°Ô∏è Response status:", response.status);

    if (!response.ok) {
      throw new Error(`Order fetch failed with status ${response.status}`);
    }

    const order = await response.json();
    console.log("‚úÖ Order loaded:", order);

    // 2Ô∏è‚É£ Build and display summary
    const itemsHtml = order.cart.map(item => `
      <tr>
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>¬£${item.price.toFixed(2)}</td>
        <td>¬£${(item.price * item.qty).toFixed(2)}</td>
      </tr>
    `).join("");

    orderDetailsDiv.innerHTML = `
      <div class="summary">
        <h2>Order Summary</h2>
        <p><strong>Name:</strong> ${order.customer.fullName}</p>
        <p><strong>Email:</strong> ${order.customer.email}</p>

        <table>
          <thead>
            <tr><th>Item</th><th>Qty</th><th>Price</th><th>Subtotal</th></tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
          <tfoot>
            <tr class="totals"><td colspan="3">Subtotal</td><td>¬£${order.subtotal.toFixed(2)}</td></tr>
            <tr class="totals"><td colspan="3">Shipping</td><td>¬£${order.shipping.toFixed(2)}</td></tr>
            <tr class="totals"><td colspan="3">Total Paid</td><td>¬£${order.total.toFixed(2)}</td></tr>
          </tfoot>
        </table>

        <h3>Shipping Info</h3>
        <p>${order.customer.address}<br>
           ${order.customer.city}, ${order.customer.state} ${order.customer.zip}<br>
           ${order.customer.country}<br>
           Phone: ${order.customer.phone}<br>
           Email: ${order.customer.email}</p>

        <a href="categories.html" class="btn-back">‚Üê Continue Shopping</a>
      </div>
    `;

    // 3Ô∏è‚É£ Trigger backend email confirmation
    const payload = {
      customer: order.customer,
      cart: order.cart,
      total: order.total,
      checkoutId: order.id,
      client_email: order.customer.email
    };

    console.log("üì® Sending payment-success payload:", payload);

    const emailRes = await fetch("https://iluminous-candle-uk-be.onrender.com/payment-success", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    console.log("üì¨ Email response:", emailRes.status);
    if (!emailRes.ok) {
      const errorText = await emailRes.text();
      console.error("‚ùå Email send failed:", errorText);
    } else {
      console.log("‚úÖ Email triggered successfully!");
    }

    // 4Ô∏è‚É£ Clear local cart
    localStorage.removeItem("lumina_cart");

  } catch (err) {
    console.error("‚ùå Error loading order:", err);
    orderDetailsDiv.innerHTML = "‚ö†Ô∏è Could not load order details.";
  }
})();
</script>

</body>
</html>
